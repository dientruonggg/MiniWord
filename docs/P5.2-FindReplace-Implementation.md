# Find/Replace Dialog UI - Implementation Documentation (P5.2)

## Overview
Successfully implemented the Find/Replace dialog UI with search result highlighting and Find Next/Previous navigation as specified in P5.2.

## Features Implemented

### 1. Find/Replace Window (Modal Dialog)
- **File**: `FindReplaceWindow.axaml` and `FindReplaceWindow.axaml.cs`
- **ViewModel**: `FindReplaceViewModel.cs`
- **Pattern**: MVVM with two-way data binding and RelayCommands

#### UI Elements:
```
┌──────────────────────────────────────────────┐
│        Find and Replace                  [X] │
├──────────────────────────────────────────────┤
│  Find what:                                  │
│  ┌────────────────────────────────────────┐  │
│  │ Enter text to find...                  │  │
│  └────────────────────────────────────────┘  │
│                                              │
│  Replace with:                               │
│  ┌────────────────────────────────────────┐  │
│  │ Enter replacement text...              │  │
│  └────────────────────────────────────────┘  │
│                                              │
│  ☐ Match case  ☐ Whole word  ☐ Use regex   │
│                                              │
│  [◄ Previous] [Next ►]     [Replace] [Replace All] │
│                                              │
│  ┌────────────────────────────────────────┐  │
│  │ Status: Found 5 match(es)              │  │
│  └────────────────────────────────────────┘  │
│                                              │
│                              [Close]         │
└──────────────────────────────────────────────┘
```

#### Features:
- Search textbox with watermark
- Replace textbox with watermark
- Three search options:
  - Match case (case-sensitive search)
  - Whole word (whole word matching)
  - Use regex (regular expression patterns)
- Navigation buttons:
  - Previous (◄) - Navigate to previous match
  - Next (►) - Navigate to next match
- Replace buttons:
  - Replace - Replace current match
  - Replace All - Replace all matches
- Status area showing:
  - Number of matches found
  - Current match position (e.g., "Match 2 of 5")
  - Error messages (e.g., "No matches found", "Invalid regex")
- Close button

#### Keyboard Shortcuts:
- **Enter** in search textbox: Perform search
- **Escape**: Close dialog
- **F3**: Find Next
- **Shift+F3**: Find Previous

### 2. Search Result Highlighting in A4Canvas
- **File**: Modified `A4Canvas.cs`

#### Implementation Details:
```csharp
// Added to A4Canvas.cs:
- _highlightCanvas: Separate canvas layer for highlights
- _highlightRectangles: List to track highlight rectangles
- _currentHighlight: Current highlighted range

// New Methods:
- HighlightSearchResult(TextRange): Highlights single result
- HighlightSearchResults(List<TextRange>): Highlights multiple results
- ClearSearchHighlights(): Clears all highlights
- ScrollToHighlight(double): Scrolls to make highlight visible
```

#### Visual Highlighting:
- Semi-transparent yellow background (Color.FromArgb(100, 255, 255, 0))
- Yellow-orange border for emphasis
- Automatic scrolling to keep highlighted text visible
- Current match uses brighter highlight
- All matches shown with lighter highlight

### 3. Integration with MainWindow
- **File**: Modified `MainWindow.axaml.cs` and `MainWindow.axaml`

#### Changes Made:
1. **Menu Integration**:
   - Added "Edit" menu with "Find/Replace..." item
   - HotKey: Ctrl+F

2. **Keyboard Shortcut**:
   - Ctrl+F opens Find/Replace dialog from anywhere in the application

3. **Dialog Wiring**:
   ```csharp
   // Delegates injected into FindReplaceWindow:
   - GetDocumentText: () => canvas.Text
   - HighlightTextRange: (range) => canvas.HighlightSearchResult(range)
   - ReplaceText: (search, replace, replaceAll) => HandleReplaceText(...)
   ```

4. **Replace Handling**:
   - Single replace: Uses SearchEngine.ReplaceFirst()
   - Replace all: Uses SearchEngine.ReplaceAll()
   - Automatically updates document text after replacement
   - Refreshes search results after replacement

### 4. ViewModel Implementation (FindReplaceViewModel)

#### Properties:
- SearchText: Two-way bound to search textbox
- ReplaceText: Two-way bound to replace textbox
- CaseSensitive: Toggle for case-sensitive search
- WholeWord: Toggle for whole word matching
- UseRegex: Toggle for regex pattern matching
- StatusText: Status message (e.g., "Found 5 match(es)")
- HasResults: Boolean indicating if search has results

#### Commands:
- FindNextCommand: Navigate to next match (can execute when HasResults)
- FindPreviousCommand: Navigate to previous match (can execute when HasResults)
- ReplaceCommand: Replace current match (can execute when HasResults)
- ReplaceAllCommand: Replace all matches (can execute when HasResults)

#### Events:
- HighlightRequested: Raised when a match should be highlighted
- ReplaceRequested: Raised when replace is requested

#### Logic:
- PerformSearch(string documentText): Performs search using SearchEngine
- Wraps around at start/end for Find Next/Previous
- Updates status text with match count and position
- Handles errors (invalid regex, empty search, etc.)

## Test Coverage

### Unit Tests (FindReplaceViewModelTests.cs)
- 20 tests covering:
  - Constructor initialization
  - Search functionality (empty text, no matches, case-sensitive, whole word, regex)
  - Navigation (Find Next/Previous, wrap-around)
  - Replace operations (single, all)
  - Command CanExecute behavior
  - Error handling (invalid regex)

### Integration Tests (FindReplaceIntegrationTests.cs)
- 11 tests covering:
  - Complete workflow scenarios
  - Search options interaction
  - Navigation wrap-around
  - Replace workflows (single and all)
  - Edge cases (overlapping matches, special characters, multiline text)
  - Error handling

**Total: 31 new tests, all passing**
**Total test count: 214 tests (183 existing + 31 new)**

## Architecture Pattern

### MVVM Compliance:
```
┌─────────────────────────────────────────────┐
│              View Layer                     │
│  FindReplaceWindow.axaml (XAML)            │
│  FindReplaceWindow.axaml.cs (Code-behind)  │
│  - Minimal code: dialog display, events    │
│  - Delegates for document interaction      │
└──────────────┬──────────────────────────────┘
               │ Data Binding & Commands
┌──────────────▼──────────────────────────────┐
│           ViewModel Layer                   │
│  FindReplaceViewModel.cs                    │
│  - ObservableObject (INotifyPropertyChanged)│
│  - RelayCommands with CanExecute            │
│  - Business logic for search/replace        │
│  - Events: HighlightRequested, ReplaceRequested │
└──────────────┬──────────────────────────────┘
               │ Uses
┌──────────────▼──────────────────────────────┐
│            Model/Service Layer              │
│  SearchEngine (from P5.1)                   │
│  - FindAll(text, pattern, options)          │
│  - ReplaceFirst(text, pattern, replacement) │
│  - ReplaceAll(text, pattern, replacement)   │
└─────────────────────────────────────────────┘
```

## Usage Examples

### Opening Find/Replace Dialog:
1. Press **Ctrl+F**
2. Or click **Edit → Find/Replace...**

### Simple Search:
1. Type search text: "hello"
2. Press Enter or click "Next ►"
3. Results highlighted in editor
4. Use Previous/Next to navigate

### Case-Sensitive Search:
1. Type search text: "Hello"
2. Check "Match case"
3. Press Enter
4. Only exact case matches found

### Whole Word Search:
1. Type search text: "test"
2. Check "Whole word"
3. Press Enter
4. Finds "test" but not "testing" or "tested"

### Regex Search:
1. Type pattern: `\d{3}-\d{4}` (phone numbers)
2. Check "Use regex"
3. Press Enter
4. Finds all matching patterns

### Replace Single:
1. Search for text
2. Navigate to desired match
3. Enter replacement text
4. Click "Replace"
5. Current match replaced

### Replace All:
1. Search for text
2. Enter replacement text
3. Click "Replace All"
4. All matches replaced at once

## Integration Points

### With SearchEngine (P5.1):
- Uses SearchEngine.FindAll() for finding matches
- Returns List<TextRange> with match positions
- Respects SearchOptions (case-sensitive, whole word, regex)
- Handles errors (invalid regex, timeout)

### With A4Canvas:
- Adds highlight canvas layer above text, below editor
- Uses TextRange positions to calculate highlight coordinates
- Approximates character positions (could be enhanced with font metrics)
- Scrolls viewport to make highlights visible
- Clears previous highlights when new search performed

### With MainWindow:
- Modal dialog (ShowDialog)
- Doesn't block main window editing
- Updates document text when replacements occur
- Marks document as dirty after replacements

## Known Limitations & Future Enhancements

### Current Limitations:
1. Highlight positioning uses approximate character width calculation
   - Could be improved with actual font metrics from FormattedText
2. Multi-page highlighting only works within visible page
3. No "Find in selection" feature
4. No "Replace with capture groups" for regex

### Potential Enhancements (not in scope for P5.2):
1. Highlight persistence during document editing
2. "Find in selection" mode
3. Search history (recent searches)
4. Regex capture group support in replacements
5. Incremental search (highlight as you type)
6. Search across multiple documents

## Files Modified/Created

### New Files:
1. `src/MiniWord.UI/ViewModels/FindReplaceViewModel.cs` (240 lines)
2. `src/MiniWord.UI/Views/FindReplaceWindow.axaml` (124 lines)
3. `src/MiniWord.UI/Views/FindReplaceWindow.axaml.cs` (150 lines)
4. `tests/MiniWord.Tests/FindReplaceViewModelTests.cs` (360 lines)
5. `tests/MiniWord.Tests/FindReplaceIntegrationTests.cs` (320 lines)

### Modified Files:
1. `src/MiniWord.UI/Controls/A4Canvas.cs` (+200 lines)
   - Added highlight canvas layer
   - Added highlighting methods
   - Added scroll-to-highlight functionality
2. `src/MiniWord.UI/Views/MainWindow.axaml` (+3 lines)
   - Added Edit menu with Find/Replace menu item
3. `src/MiniWord.UI/Views/MainWindow.axaml.cs` (+100 lines)
   - Added Ctrl+F keyboard shortcut
   - Added ShowFindReplaceDialog() method
   - Added HandleReplaceText() method
   - Wired up menu item click handler

## Verification

### Build Status:
✅ Build successful with 0 errors, 0 warnings (fixed RulerControl warning)

### Test Status:
✅ All 214 tests passing
- 183 existing tests (unchanged)
- 20 new unit tests (FindReplaceViewModelTests)
- 11 new integration tests (FindReplaceIntegrationTests)

### Code Quality:
- Follows existing MVVM patterns
- Comprehensive logging with Serilog
- Proper error handling
- Thread-safe operations
- Clean separation of concerns

## Conclusion

P5.2 implementation is **complete** with:
- ✅ FindReplaceWindow.axaml (modal dialog) created
- ✅ Search result highlighting in editor implemented
- ✅ Find Next/Previous navigation working
- ✅ Ctrl+F keyboard shortcut integrated
- ✅ All existing tests passing
- ✅ 31 new tests added and passing
- ✅ Smooth integration with P5.1 (SearchEngine)

The implementation follows MVVM best practices, integrates seamlessly with existing code, and provides a robust Find/Replace experience for users.
